---
title: "Basic statistics with R - session 1"
author: G√©raldine Derroire
institute: Cirad - UnB
date: last-modified
format: 
  revealjs:
    theme: solarized
    output-location: fragment 
    slide-number: true
    preview-links: true
    chalkboard: true
    link-external-icon: true
    link-external-newwindow: true
    incremental: true
execute:
  echo: true   
  warning: true
  message: true 
  cache: true
editor: 
  markdown: 
    wrap: sentence
---

<!-- Chnage the title ? maybe not basic...-->


<!--
test de base : t-tests, correlation, Anova...

https://www.statology.org/choosing-the-right-statistical-test-a-decision-tree-approach/

PARTOUT : https://pmarchand1.github.io/ECL7102/

-->

```{r}
library(tidyverse)
library(questionr)
```



# Quelques rappels???

## Lois de distribution

=> ne parler que de la distribution normale??? oui

https://ericmarcon.github.io/Cours-R-Geeft/TP_2.html#14

+ mentionner le distribution zoo

Ici ou en d√©but de session sur le mod√®le lin√©aire?

https://pmarchand1.github.io/ECL7102/notes_cours/3-Modeles_statistiques.html


## Parametrique vs non param√©trique


# Testing if two groups differ considering a quantitative variable

## Let's work with the Nouragues tree data

[*Heights and diameters of trees in two 1-ha plots from the Nouragues forest (French Guiana)*]{style="font-size: 30px"}

[Let's load them]{style="font-size: 30px"}

```{r, message=FALSE}
library(BIOMASS)
data(NouraguesHD) # load the data
dt_HD <- as_tibble(NouraguesHD) # rename and transform to tibble
rm(NouraguesHD) # remove
```

[[and select 2 genus:]{style="font-size: 30px"}]{.fragment}

```{r, message=FALSE, eval = FALSE, echo=FALSE}
# for me to choose the most abundant sp with a distrib that works well
abund <- dt_HD %>% count(genus) %>% arrange(desc(n)) %>% slice_head(n = 10) 

dt_HD %>% filter(genus %in% abund$genus) %>% 
  ggplot(aes(x=genus, y=H)) + geom_boxplot()
```


::: fragment
```{r}
# one dataset with both genus
dt_sub <- dt_HD %>% 
  filter(genus %in% c("Dicorynia", "Protium"))

# one dataset per genus
d_Dico <- filter(dt_sub, genus == "Dicorynia")
d_Prot <- filter(dt_sub, genus == "Protium")
```
:::

::: notes
We do both a common dataset and two dataset per genus
:::

## Do the two genus differ in height?

[Let's explore this graphically:]{style="font-size: 30px"}

```{r}
#| warning: false
#| out.width: 80%
dt_sub %>% 
  ggplot(aes(x=genus, y=H)) + 
  geom_boxplot()
```


## Are the distribution of height in both genus normal?

[To decide which test to use, we first check the normality of the distribution with a Shapiro-Wilk test, using the function [shapiro.test]{style="color:indianred;"}]{style="font-size: 30px"}

::::: columns
::: {.column width="50%"}
```{r}
shapiro.test(d_Dico$H)
```
:::

::: {.column width="50%"}
```{r}
shapiro.test(d_Prot$H)
```
:::
:::::

[[The tests are non-significant, so they don't reject the hypothesis of normality. 
We can consider the two distributions as normal.]{style="font-size: 30px"}]{.fragment}

## Are the distribution of height in both genus normal?

[We could also check the normality graphically with normal QQ plot, using the function [qqnorm]{style="color:indianred;"}:]{style="font-size: 30px"}

::::: columns
::: {.column width="50%"}
```{r}
#| fig-width: 2.8
#| fig-height: 2.8
qqnorm(d_Dico$H)
qqline(d_Dico$H)
```
:::

::: {.column width="50%"}
```{r}
#| fig-width: 2.8
#| fig-height: 2.8
qqnorm(d_Prot$H)
qqline(d_Prot$H)
```
:::
:::::

[[*A QQ plot compares the quantiles of the observed distribution against a normal distribution. If the points fall reasonably on the diagonal line, we consider the data as normally distributed.*]{style="font-size: 25px"}]{.fragment}


## t-test

[As the two distributions are normal, we can do a t-test using the function [t.test]{style="color:indianred;"}:]{style="font-size: 30px"}

[[A t-test test the equality of means of two groups: **H0: equality of the means**]{style="font-size: 30px"}]{.fragment}

::: fragment
```{r}
t.test(dt_sub$H ~ dt_sub$genus)
```
:::

[The result is significant, so we can reject the null hypothesis that the mean of both group are equal and conclude that the two genus differ in height.]{style="font-size: 30px"}

::: notes
the Welch modification is done because it handle better unequal variances and unequal sample size

the test tell us that the difference between the two is between 6.67 and 17.18 meters (95% confidence)
::: 

## Do the two genus differ in diameter?

[Let's explore this graphically:]{style="font-size: 30px"}

```{r}
#| warning: false
#| out.width: 80%
dt_sub %>% 
  ggplot(aes(x=genus, y=D)) + 
  geom_boxplot()
```

## Are the distribution of diameter in both genus normal?

[Let's first test if the distribution of diameters are normal:]{style="font-size: 30px"}

::::: columns
::: {.column width="50%"}
```{r}
shapiro.test(d_Dico$D)
```
:::

::: {.column width="50%"}
```{r}
shapiro.test(d_Prot$D)
```
:::
:::::

[[The tests are significant, so they reject the hypothesis of normality.]{style="font-size: 30px"}]{.fragment}

## Are the distribution of diameter in both genus normal?

[This is how the QQ plots look:]{style="font-size: 30px"}

::::: columns
::: {.column width="50%"}
```{r}
#| fig-width: 2.8
#| fig-height: 2.8
qqnorm(d_Dico$D)
qqline(d_Dico$D)
```
:::

::: {.column width="50%"}
```{r}
#| fig-width: 2.8
#| fig-height: 2.8
qqnorm(d_Prot$D)
qqline(d_Prot$D)
```
:::
:::::

[[The distributions of diameters are not normal, so we cannot use a t-test.]{style="font-size: 30px"}]{.fragment}

## Wikcoxon rank test

[We can do a Wilcoxon rank test, which is the non-parametric equivalent to the t-test, using the function [wilcox.test]{style="color:indianred;"}:]{style="font-size: 30px"}

```{r}
wilcox.test(dt_sub$H ~dt_sub$genus)
```

[[The result is significant, so we can reject the null hypothesis that the mean of both group are equal and conclude that the two genus differ in diameter.]{style="font-size: 30px"}]{.fragment}


::: notes
The test assume all values to be different, but there are some ties (equal values) so the p-value is approximates
=> here very small so OK
:::


## What if the data are paired?

[Let's load some data:]{style="font-size: 30px"}

```{r}
load("data/data_statistics.RData")
```

[[The data *dt_thin* is a dummy dataset of the growth (in cm DBH/year) of 100 tree before and after thinning.]{style="font-size: 30px"}]{.fragment}

::: fragment
```{r}
str(dt_thin)
```
:::

[[These data are **paired**, as each individual tree is measured twice: (before and after thinning).]{style="font-size: 30px"}]{.fragment}


## Growth before and after thinning

[Let's explore the data graphically:]{style="font-size: 30px"}

```{r}
#| out.width: 80%
ggplot(dt_thin, aes(x=treat, y=growth)) + geom_boxplot()
```

## Growth before and after thinning

[First, we pivot the data to a wide format:]{style="font-size: 30px"}

```{r}
dt_thin_w <- dt_thin %>% 
  pivot_wider(names_from = "treat", 
              values_from = "growth")

slice_head(dt_thin_w, n = 5) # check the first rows
```

## Are the distributions normal?

[Let's check the normality graphically:]{style="font-size: 30px"}

::::: columns
::: {.column width="50%"}
```{r}
#| fig-width: 3
#| fig-height: 3
qqnorm(dt_thin_w$before)
qqline(dt_thin_w$before)
```
:::

::: {.column width="50%"}
```{r}
#| fig-width: 3
#| fig-height: 3
qqnorm(dt_thin_w$after)
qqline(dt_thin_w$after)
```
:::
:::::

::: notes
no needs to check with a test because

* qq plot are good and visual explo OK

* t-test is relatively robust to violation of normality assumption
:::

## t-test for paired data

[We can do a t-test for paired data by specifying **paired = TRUE** in the function [t.test]{style="color:indianred;"}:]{style="font-size: 30px"}

::::: columns
::: {.column width="50%"}
```{r}
t.test(dt_thin_w$before, 
       dt_thin_w$after,
       paired=T)
```
:::

::: {.column width="50%"}
[[The result is significant, so we can conclude that the growth before and after thinning differs.]{style="font-size: 30px"}]{.fragment}

[[üí° If the data are not normally distributed, we can do a Wikcoxon rank test for paired data in a similar way]{style="font-size: 30px"}]{.fragment}
:::
:::::

::: notes
give the 95% confidence interval of the difference (before - after)
::: 

# Testing the association between two categorical variables

## Do the number of occurences of several genus depends on the plot? {.smaller}

[We are going to work on the 10 most abundant genus in the Nouragues dataset, let's select them:]{style="font-size: 30px"}


::::: columns
::: {.column width="50%"}
```{r}
# look at the 10 most abundant genus
abd_10 <- dt_HD %>% 
  count(genus) %>% 
  arrange(desc(n)) %>% 
  slice_head(n = 10) 

abd_10
```
:::


::: {.column width="50%"}
::: fragment
```{r}
# take a subset of dt_HD containing the 10 most abundant genus
dt_sub10 <- dt_HD %>% 
  filter(genus %in% abd_10$genus)
```
:::
:::
:::::


## Contingency table

[Let's start by doing a contingency table, using the function [table]{style="color:indianred;"}.]{style="font-size: 30px"}

[This gives the number of observations for each pairs of categories.]{style="font-size: 30px"}

```{r}
tab_abd <- table(dt_sub10$genus, dt_sub10$plotId)
tab_abd
```

## Percentages per category

[We can look at the percentages per column (*here* per plot), using the function [cprop]{style="color:indianred;"} of the package [questionr]{style="color:indianred;"}:]{style="font-size: 30px"}

```{r}
cprop(tab_abd)
```
[[‚ö†Ô∏è Here we look at the frequency per column because we are interested in the effect of the plot and the plot is in column. The function [lprop]{style="color:indianred;"} also exists to look at frequency per row.]{style="font-size: 30px"}]{.fragment}

::: notes
We see that the occurence of most genus seems to depend on the plot
:::

::: notes
here in columns because...
:::

## Graphical exploration

[We can do a mosaic plot, using the function [mosaicplot]{style="color:indianred;"} to explore the association graphically:]{style="font-size: 30px"}

```{r}
mosaicplot(tab_abd)
```

## $\chi^2$ test {.smaller}

[We can then perform a $\chi^2$ test, to test the independence of the two categorical variables.
**H0: the variables are independent**]{style="font-size: 30px"}

::::: columns
::: {.column width="40%"}
[[We use the function [chisq.test]{style="color:indianred;"} on the **contingency table** (not on the percentage):]{style="font-size: 30px"}]{.fragment}
:::

::: {.column width="60%"}
::: fragment
```{r}
res_chi2 <- chisq.test(tab_abd)
res_chi2
```
:::
:::
:::::

[[The result shows the following values:]{style="font-size: 30px"}]{.fragment}

* [*X-squared* is the value of the $\chi^2$ statistics, which is a "distance" between the observed occurrences and the expected ones if the variables were independent.]{style="font-size: 28px"}

* [*df* is the number of degrees of freedom]{style="font-size: 28px"}

* [*p-value* is the probability to get such a *X-squared* value under the assumption of independence.]{style="font-size: 28px"}
[[**Here the *p-value* is very low, so we can reject the null hypothesis of independence.**]{style="font-size: 28px"}]{.fragment}


## $\chi^2$ test {.scrollable}

* [The $\chi^2$ needs to be done on contingency tables and not on proportions, as the size of the sample needs to be known.]{style="font-size: 30px"}

* [It is less reliable if the sample size is too small. It should not be used if any of the expected frequency under H0 is below 5. Let's check this:]{style="font-size: 30px"}

::: fragment
```{r}
res_chi2$expected
```
:::

::: notes
Here it is ok
:::

## Residuals 

[We can look at the residuals using the function [chisq.residuals]{style="color:indianred;"} of the package [questionr]{style="color:indianred;"}:]{style="font-size: 30px"}

::::: columns
::: {.column width="40%"}

```{r}
chisq.residuals(tab_abd)
```
:::

::: {.column width="60%}

* [residuals < -2 indicate under-representation]{style="font-size: 30px"}

* [residuals > 2 indicate over-representation]{style="font-size: 30px"}

* [residuals in [-2, 2] indicate no significant difference to independence]{style="font-size: 30px"}

[[*The threshold of 2 correspond to a 95% confidence interval.*]{style="font-size: 30px"}]{.fragment}
:::

::::

## Residuals

[We can also present the residuals graphically with the argument *shade = TRUE* in the function [mosaicplot]{style="color:indianred;"}:]{style="font-size: 30px"}

```{r}
mosaicplot(tab_abd, 
           shade = TRUE,
           las = 3, # vertical orientation of labels
           main = "") # remove main title
```








# correlation lin√©raire (Pearson)

https://juba.github.io/tidyverse/04-bivarie.html#tests-statistiques

https://ericmarcon.github.io/Cours-R-Geeft/TP_5.html#8

# Correlation des rangs (Spearman)

https://juba.github.io/tidyverse/04-bivarie.html#tests-statistiques

# Anova

https://ericmarcon.github.io/Cours-R-Geeft/Anova.html#21




# Acknowledgments

::: {.nonincremental}

* Barnier J. *Introduction √† R et au tidyverse* [in French](https://juba.github.io/tidyverse/){preview-link="false"}

COURS ERIC GEEFT

? LAMARANGE ? MARCHAND ?

:::

# Ressources

::: {.nonincremental}
??????
:::

::: {.nonincremental}
